<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Preview Certificates</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-5">

    <h2 class="text-center mb-4">üìã Preview Before Sending</h2>

    <!-- SUMMARY ALERT -->
    {% set ready = preview_data | selectattr("status", "equalto", "Ready") | list | length %}
    {% set missing = preview_data | selectattr("status", "equalto", "Missing") | list | length %}

    <div class="alert alert-info">
        <b>Total:</b> {{ preview_data|length }} |
        <b class="text-success">Ready:</b> {{ ready }} |
        <b class="text-danger">Missing:</b> {{ missing }}
    </div>

    {% if missing > 0 %}
    <div class="alert alert-warning">
        ‚ö†Ô∏è Some certificates are missing. Emails will be sent only to participants with available certificates.
    </div>
    {% endif %}

    <!-- PREVIEW TABLE -->
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Email</th>
                <th>Certificate</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for row in preview_data %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ row.name }}</td>
                <td>{{ row.email }}</td>
                <td>{{ row.certificate }}</td>
                <td>
                    {% if row.status == "Ready" %}
                        <span class="badge bg-success">Ready</span>
                    {% else %}
                        <span class="badge bg-danger">Missing</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- CONFIRMATION FORM -->
    <div class="card shadow-sm mt-4">
        <div class="card-body">

            <h5 class="mb-3">üì® Sender Details</h5>

            <form action="/process" method="POST" onsubmit="showLoader()">

                <!-- REQUIRED -->
                <input type="hidden" name="csv_filename" value="{{ csv_filename }}">

                <div class="mb-3">
                    <label class="form-label">Sender Email</label>
                    <input type="email" name="sender_email" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">App Password</label>
                    <input type="password" name="app_password" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Email Subject</label>
                    <input type="text" name="subject" class="form-control" value="Your Certificate">
                </div>

                <!-- LOADER -->
                <div id="loading" class="text-center my-3" style="display:none;">
                    <div class="spinner-border text-success"></div>
                    <p class="mt-2">Sending certificates, please wait...</p>
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-success btn-lg">
                        ‚úÖ Confirm & Send Certificates
                    </button>
                </div>
            </form>

        </div>
    </div>

    <div class="text-center mt-3">
        <a href="/" class="btn btn-secondary">
            ‚¨Ö Back
        </a>
    </div>

</div>

<!-- JS -->
<script>
function showLoader() {
    document.getElementById("loading").style.display = "block";
}
</script>

</body>
</html>
